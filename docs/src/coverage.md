# Coverage Post-processing Guide

This guide explains how to generate human-readable and machine-parseable coverage reports using the **CoveragePostprocessing** extension of `CTBase.jl`.

## ⚠️ Prerequisites

**Important**: The `Coverage` package must be installed in your base Julia environment for coverage post-processing to work properly:

```bash
# In your base Julia environment (not the project environment)
julia --project=@v1.12 -e 'using Pkg; Pkg.add("Coverage")'
```

This is required because coverage processing happens at the Julia level and needs the `Coverage` package to be available globally.

## Setting up Coverage

To generate actionable coverage reports, we use a dedicated `coverage.jl` script. This script processes the raw `.cov` files generated by Julia and produces summaries that are easy to read.

### Example `test/coverage.jl`

```julia
# Add the test directory to the load path so Julia can find dependencies from 
# test/Project.toml.
pushfirst!(LOAD_PATH, @__DIR__)

using Pkg
using CTBase # Provides postprocess_coverage
using Coverage

# This function:
# 1. Aggregates coverage data.
# 2. Generates an LCOV file (coverage/lcov.info).
# 3. Generates a markdown summary (coverage/cov_report.md).
# 4. Archives used .cov files to keep the directory clean.
CTBase.postprocess_coverage(; 
    root_dir=dirname(@__DIR__) # Point to the package root
)
```

## Running with Coverage

To run tests and generate the report:

```bash
julia --project -e '
    using Pkg; 
    Pkg.test("MyPackage"; coverage=true); 
    include("test/coverage.jl")
'
```

The resulting `coverage/cov_report.md` will contain a list of files with their coverage percentages and, crucially, a list of uncovered lines. This allows identifying exactly which parts of the code need more tests.

## Coverage Artifacts

The post-processing script produces:

- `coverage/lcov.info`: LCOV format for CI integration (e.g., Codecov).
- `coverage/cov_report.md`: Human-readable summary with uncovered lines.
- `coverage/cov/`: Archived `.cov` files.
